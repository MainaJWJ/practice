<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>jun0824의 블로그</title>

    <link rel="stylesheet" href="windowsXP.css">
    <link rel="stylesheet" href="custom.css">
    <link rel="icon" href="./image/windowslogo.png">
    <!-- Webamp 라이브러리 추가 (Milkdrop 지원 버전) -->
    <script type="module">
        import Webamp from "https://unpkg.com/webamp@0.0.0-next-f432117/butterchurn";
        window.Webamp = Webamp;
    </script>
    <!-- Webamp 관리자 스크립트 추가 -->
    <script src="webamp/webamp-manager.js"></script>
</head>

<body>

    <body id="desktop-body">
            <div id="desktop-area">

    <div class="desktop-icons">

        <a href="./mycomputer.html" class="desktop-icon" data-title="내 컴퓨터" data-icon-url="./image/mycomputer.png" data-open-mode="window">
            <img src="./image/mycomputer.png" alt="내 컴퓨터">
            <span>내 컴퓨터</span>
        </a>


        <a href="./folder.html" class="desktop-icon" data-title="새 폴더" data-icon-url="./image/folder.png" data-open-mode="window">
            <img src="./image/folder.png" alt="새 폴더">
            <span>새 폴더</span>
        </a>


                <a href="https://www.google.com/webhp?igu=1" class="desktop-icon" data-title="Internet Explore" data-icon-url="./image/explore.png" data-open-mode="window">
            <img src="./image/explore.png" alt="인터넷">
            <span>Internet Explore</span>
        </a>


        <a href="./jspaint/index.html" class="desktop-icon" data-title="그림판"  data-icon-url="./image/paint.png" data-open-mode="window">
            <img src="./image/mspaint.png" alt="그림판">
            <span>그림판</span>
        </a>


        <a href="./texteditor.html" class="desktop-icon" data-title="문서편집기"  data-icon-url="./image/texteditor.png" data-open-mode="window">
            <img src="./image/texteditor.png" alt="문서편집기">
            <span>문서편집기</span>


            <!-- Webamp 아이콘 추가 -->
        <a href="#" class="desktop-icon" id="webamp-icon" data-title="Webamp" data-icon-url="./image/mediaplayer.png">
            <img src="./image/mediaplayer.png" alt="Webamp">
            <span>Webamp</span>
        </a>




            <a href="./minipaint/index.html" class="desktop-icon" data-title="포토샵"  data-icon-url="./image/paint.png" data-open-mode="window">
                <img src="./image/paint.png" alt="포토샵">
                <span>포토샵</span>
            </a>
        

                    <a href="./textcounter.html" class="desktop-icon" data-title="글자수세기"  data-icon-url="./image/shell.png" data-open-mode="window">
            <img src="./image/shell.png" alt="쉘">
            <span>글자수세기</span>
        </a>     

        <a href="./terminal.html" class="desktop-icon" data-title="명령 프롬프트" data-icon-url="./image/cmd.png" data-open-mode="window">
            <img src="./image/cmd.png" alt="명령 프롬프트">
            <span>명령 프롬프트</span>
        </a>
        </a>
        <a href="#" class="desktop-icon" id="pinball-icon" data-title="3D Pinball" data-icon-url="./image/pinball.png">
            <img src="./image/pinball.png" alt="3D Pinball">
            <span>3D Pinball</span>
        </a>
        <a href="#" class="desktop-icon" id="minesweeper-icon" data-title="Minesweeper" data-icon-url="./image/minesweeper.png">
            <img src="./image/minesweeper.png" alt="Minesweeper">
            <span>Minesweeper</span>
        </a>
        <a href="#" class="desktop-icon" id="screensaver-icon" data-title="Pipe Screensaver" data-icon-url="./image/protect.png">
            <img src="./image/protect.png" alt="Pipe Screensaver">
            <span>Pipe Screensaver</span>
        </a>
        <a href="#" class="desktop-icon" id="flower-screensaver-icon" data-title="Flower Screensaver" data-icon-url="./image/protect.png">
            <img src="./image/protect.png" alt="Flower Screensaver">
            <span>Flower Screensaver</span>
        </a>
    </div>

    <div id="webamp-container"></div>

    <!-- 화면보호기 오버레이 (초기에는 숨김) -->
    <div id="screensaver-overlay" style="display:none; position:fixed; z-index:99999; left:0; top:0; width:100vw; height:100vh; background:black;">
      <iframe id="screensaver-iframe" src="" style="width:100vw; height:100vh; border:none;"></iframe>
    </div>
    <!-- Flower 화면보호기 오버레이 (초기에는 숨김) -->
    <div id="flower-screensaver-overlay" style="display:none; position:fixed; z-index:99999; left:0; top:0; width:100vw; height:100vh; background:black;">
      <iframe id="flower-screensaver-iframe" src="" style="width:100vw; height:100vh; border:none;"></iframe>
    </div>
    <!-- Turn Off Computer 오버레이 (iframe 없이 직접 구현) -->
    <div id="turnoff-overlay" style="display:none; position:fixed; z-index:99999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25);">
      <div id="turnoff-dialog" style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:#2361b1; border-radius:8px; box-shadow:0 8px 32px rgba(0,0,0,0.4); width:350px; padding:0 0 24px 0; box-sizing:border-box; border:2px solid #003399; font-family:Tahoma,Verdana,Arial,sans-serif;">
        <div style="background:linear-gradient(to bottom,#2361b1 60%,#0a3a7a 100%); color:#fff; font-size:22px; font-weight:bold; padding:16px 16px 8px 16px; border-radius:8px 8px 0 0; display:flex; align-items:center; justify-content:space-between;">
          Turn off computer
          <img src="./image/windowslogo.png" alt="Windows XP Logo" style="width:38px;height:38px;margin-left:8px;">
        </div>
        <div style="display:flex; justify-content:space-around; margin:32px 0 16px 0;">
          <div class="turnoff-btn" id="standby-btn" style="display:flex;flex-direction:column;align-items:center;cursor:pointer;user-select:none;width:80px;">
            <img src="./image/logoff.png" alt="Stand By" style="width:48px;height:48px;margin-bottom:8px;border-radius:8px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.15);border:2px solid #fff;transition:border 0.2s;">
            <span style="color:#fff;font-size:15px;text-shadow:1px 1px 2px #003399;margin-top:2px;">Log Off</span>
          </div>
          <div class="turnoff-btn" id="turnoff-btn" style="display:flex;flex-direction:column;align-items:center;cursor:pointer;user-select:none;width:80px;">
            <img src="./image/turnoff.png" alt="Turn Off" style="width:48px;height:48px;margin-bottom:8px;border-radius:8px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.15);border:2px solid #fff;transition:border 0.2s;">
            <span style="color:#fff;font-size:15px;text-shadow:1px 1px 2px #003399;margin-top:2px;">Turn Off</span>
          </div>
          <div class="turnoff-btn" id="restart-btn" style="display:flex;flex-direction:column;align-items:center;cursor:pointer;user-select:none;width:80px;">
            <img src="./image/restart.png" alt="Restart" style="width:48px;height:48px;margin-bottom:8px;border-radius:8px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.15);border:2px solid #fff;transition:border 0.2s;">
            <span style="color:#fff;font-size:15px;text-shadow:1px 1px 2px #003399;margin-top:2px;">Restart</span>
          </div>
        </div>
        <button id="turnoff-cancel-btn" style="position:absolute;right:18px;bottom:12px;background:#fff;color:#003399;border:1.5px solid #003399;border-radius:4px;font-size:15px;padding:2px 18px;cursor:pointer;font-family:inherit;box-shadow:0 2px 8px rgba(0,0,0,0.10);transition:background 0.2s,color 0.2s;">Cancel</button>
      </div>
    </div>

    <div class="start-menu" id="startMenu">
<div class="start-menu-header">
    <img src="./image/usericon.png" class="user-avatar" alt="User">
    <span class="user-name">jun0824</span>
</div>
<div class="start-menu-body">
    <div class="start-menu-left" id="startMenuLeft">
        </div>
    <div class="start-menu-right" id="startMenuRight">
        </div>
</div>
<div class="start-menu-footer">
    <button id="logOffButton">
        <img src="./image/logoff.png" alt="Log Off">
        <span>Log Off</span>
    </button>
    <button id="turnOffButton">
        <img src="./image/turnoff.png" alt="Turn Off Computer">
        <span>Turn Off Computer</span>
    </button>
</div>
    </div>


    <!-- 화면하단 시작버튼과 작업탭 -->
    <div class="taskbar">
        <button class="start-button" id="startButton" aria-label="Start"></button>
        <div class="taskbar-windows"></div>




        <!-- 시계공간 내부 -->
    <div class="taskbar-notification-area">
        <div class="notification-icon" id="volume-icon-container">
            <img src="./image/volume.png" alt="볼륨" title="볼륨">
            <div class="volume-popup">
                <div class="title-bar">
                    <div class="title-bar-text">볼륨</div>
                </div>
                <div class="window-body">
                    <input type="range" id="volume-slider" min="0" max="100" value="75" class="slider">
                    <div class="field-row" style="margin-top: 5px;">
                        <input type="checkbox" id="mute-checkbox">
                        <label for="mute-checkbox">음소거</label>
                    </div>
                </div>
            </div>
        </div>
        <img src="./image/good.png" alt="상태" title="상태" class="notification-icon">
        <img src="./image/printer.png" alt="프린터" title="프린터" class="notification-icon">
        <span id="taskbar-clock"></span>
    </div>
    </div>

<script>
let highestZIndex = 100;
document.addEventListener('DOMContentLoaded', () => {

    /* ==========================================================================
       1. 전역 변수 및 DOM 요소
    ========================================================================== */
    const desktopArea = document.getElementById('desktop-area');
    const desktopIcons = document.querySelectorAll('.desktop-icon');
    const taskbarWindows = document.querySelector('.taskbar-windows');
    const startButton = document.getElementById('startButton');
    const startMenu = document.getElementById('startMenu');
    const clockElement = document.getElementById('taskbar-clock');
    const volumeIconContainer = document.getElementById('volume-icon-container');
    const volumePopup = volumeIconContainer.querySelector('.volume-popup');
    const volumeSlider = document.getElementById('volume-slider');
    const muteCheckbox = document.getElementById('mute-checkbox');

    let currentContextMenu = null;
    let globalVolume = 0.75; // 기본 볼륨 (0.0 ~ 1.0)
    let isGlobalMuted = false; // 기본 음소거 상태

    /* ==========================================================================
       2. 핵심 기능 함수 (창 관리, 시계 등)
    ========================================================================== */

    // 창을 맨 앞으로 가져오고 활성화하는 함수
    function bringToFront(windowEl) {
        highestZIndex++;
        windowEl.style.zIndex = highestZIndex;
        
        // Webamp 매니저의 z-index도 동기화
        if (window.webampManager) {
            window.webampManager.updateZIndex(highestZIndex);
        }
        
        document.querySelectorAll('.taskbar-tab').forEach(tab => tab.classList.remove('active'));
        if (windowEl.taskbarTab) {
            windowEl.taskbarTab.classList.add('active');
        }
    }

    // 작업표시줄 시계 업데이트 함수
    function updateClock() {
        const now = new Date();
        let hours = now.getHours();
        let minutes = now.getMinutes();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12 || 12; // 12시간제로 변경
        minutes = String(minutes).padStart(2, '0');
        if (clockElement) clockElement.textContent = `${hours}:${minutes} ${ampm}`;
    }
// ▼▼▼ 2. 이 함수를 새로 추가합니다. ▼▼▼
// 모든 창의 오디오/비디오에 현재 볼륨/음소거 상태를 적용하는 함수
function applyGlobalAudioState() {
    document.querySelectorAll('iframe').forEach(iframe => {
        try {
            const mediaElements = iframe.contentWindow.document.querySelectorAll('audio, video');
            mediaElements.forEach(media => {
                media.volume = globalVolume;
                media.muted = isGlobalMuted;
            });
        } catch (e) {
            // 외부 사이트(CORS) 등 접근 불가 오류는 무시합니다.
        }
    });
}
    /* ==========================================================================
       3. 창 생성 및 상호작용 관리
    ========================================================================== */

    // 새 창을 만드는 메인 함수
    function createWindow(options) {
        const windowEl = document.createElement('div');
        windowEl.className = 'window';
        windowEl.style.cssText = `width: ${options.width || 660}px; height: ${options.height || 500}px; position: absolute; top: 40px; left: 250px; display: flex; flex-direction: column; padding: 3px;`;
        const iconHtml = options.iconUrl ? `<img src="${options.iconUrl}" class="title-bar-icon" alt="">` : '';
        windowEl.innerHTML = `
            <div class="title-bar"><div class="title-bar-text">${iconHtml}${options.title}</div><div class="title-bar-controls">
                <button aria-label="Minimize"></button>
                <button aria-label="Maximize"${options.resizable === false ? ' disabled style=\"opacity:0.5;pointer-events:none;\"' : ''}></button>
                <button aria-label="Close"></button>
            </div></div>
            <div class="window-body" style="flex-grow: 1; padding: 0; margin: 0; min-height: 0;"><iframe src="${options.iframeSrc}" style="width:100%; height:100%; border:0;"></iframe></div>
            ${options.resizable === false ? '' : `
            <div class="resizer top-left"></div><div class="resizer top-right"></div><div class="resizer bottom-left"></div><div class="resizer bottom-right"></div>
            <div class="resizer top"></div><div class="resizer right"></div><div class="resizer bottom"></div><div class="resizer left"></div>
            `}
        `;
        // createWindow 함수 내부...

    // ▼▼▼ 3. 이 부분을 추가합니다. ▼▼▼
    const iframe = windowEl.querySelector('iframe');
    iframe.addEventListener('load', () => {
        applyGlobalAudioState();
    });

        document.body.appendChild(windowEl);
        makeWindowInteractive(windowEl, options);
    }

    // 창에 모든 상호작용 기능을 추가하는 함수
    function makeWindowInteractive(win, options) {
        const titleBar = win.querySelector('.title-bar');
        const minimizeButton = win.querySelector('button[aria-label="Minimize"]');
        const maximizeButton = win.querySelector('button[aria-label="Maximize"]');
        const closeButton = win.querySelector('button[aria-label="Close"]');
        let isMaximized = false;
        let originalState = {};

        const taskbarTab = document.createElement('button');
        taskbarTab.className = 'taskbar-tab';
        if (options.iconUrl) {
            taskbarTab.innerHTML = `<img src="${options.iconUrl}" class="taskbar-tab-icon">`;
        }
        taskbarTab.innerHTML += `<span>${options.title}</span>`;
        taskbarWindows.appendChild(taskbarTab);
        win.taskbarTab = taskbarTab;

// --- 드래그 기능 (오버레이 방식) ---
let isDragging = false;
let dragOffsetX, dragOffsetY;

titleBar.addEventListener('mousedown', (e) => {
    if (isMaximized || e.target.closest('.title-bar-controls')) return;

    isDragging = true;
    dragOffsetX = e.clientX - win.offsetLeft;
    dragOffsetY = e.clientY - win.offsetTop;
    bringToFront(win);

    // 화면 전체를 덮는 투명 오버레이 생성
    const overlay = document.createElement('div');
    overlay.className = 'drag-overlay';
    document.body.appendChild(overlay);

    const onDrag = (e) => {
        if (!isDragging) return;
        win.style.left = `${e.clientX - dragOffsetX}px`;
        win.style.top = `${e.clientY - dragOffsetY}px`;
    };

    const onStopDrag = () => {
        isDragging = false;
        document.body.removeChild(overlay); // 드래그가 끝나면 오버레이 제거
    };
    
    // 이제 마우스 이벤트는 오버레이 위에서 감지
    overlay.addEventListener('mousemove', onDrag);
    overlay.addEventListener('mouseup', onStopDrag, { once: true });
});

// 크기 조절 기능 (is-resizing 클래스 토글 기능 추가)
win.querySelectorAll('.resizer').forEach(resizer => {
    resizer.addEventListener('mousedown', (e) => {
        if (isMaximized) return;
        e.preventDefault();
        
        // ▼▼▼ 클릭 시작 시 'is-resizing' 클래스 추가 ▼▼▼
        resizer.classList.add('is-resizing');

        let startX = e.clientX, startY = e.clientY;
        let startWidth = win.offsetWidth, startHeight = win.offsetHeight;
        let startLeft = win.offsetLeft, startTop = win.offsetTop;
        
        const onResize = (e) => {
            const dx = e.clientX - startX, dy = e.clientY - startY;
            if (resizer.classList.contains('right') || resizer.classList.contains('bottom-right') || resizer.classList.contains('top-right')) win.style.width = `${startWidth + dx}px`;
            if (resizer.classList.contains('bottom') || resizer.classList.contains('bottom-right') || resizer.classList.contains('bottom-left')) win.style.height = `${startHeight + dy}px`;
            if (resizer.classList.contains('left') || resizer.classList.contains('bottom-left') || resizer.classList.contains('top-left')) { win.style.width = `${startWidth - dx}px`; win.style.left = `${startLeft + dx}px`; }
            if (resizer.classList.contains('top') || resizer.classList.contains('top-right') || resizer.classList.contains('top-left')) { win.style.height = `${startHeight - dy}px`; win.style.top = `${startTop + dy}px`; }
        };
        
        const onStopResize = () => {
            // ▼▼▼ 클릭 종료 시 'is-resizing' 클래스 제거 ▼▼▼
            resizer.classList.remove('is-resizing');
            document.removeEventListener('mousemove', onResize);
        };

        document.addEventListener('mousemove', onResize);
        document.addEventListener('mouseup', onStopResize, { once: true });
    });
});

        // 컨트롤 버튼 기능
        closeButton.addEventListener('click', () => { win.remove(); taskbarTab.remove(); });
        maximizeButton.addEventListener('click', () => {
            if (!isMaximized) originalState = { top: win.style.top, left: win.style.left, width: win.style.width, height: win.style.height };
            isMaximized = !isMaximized;
            win.classList.toggle('maximized', isMaximized);
            if (!isMaximized) Object.assign(win.style, originalState);
            maximizeButton.setAttribute('aria-label', isMaximized ? 'Restore' : 'Maximize');
        });
        minimizeButton.addEventListener('click', () => { win.classList.add('minimized'); taskbarTab.classList.remove('active'); });

        // 작업표시줄 탭 기능
        taskbarTab.addEventListener('click', () => {
            const isMinimized = win.classList.contains('minimized');
            const isAlreadyActive = win.style.zIndex == highestZIndex && !isMinimized;
            if (isAlreadyActive) {
                win.classList.add('minimized');
                taskbarTab.classList.remove('active');
            } else {
                win.classList.remove('minimized');
                bringToFront(win);
            }
        });

        win.addEventListener('mousedown', () => bringToFront(win), true);
        bringToFront(win);

        // 리사이즈 이벤트 등록
        if (options.resizable !== false) {
            win.querySelectorAll('.resizer').forEach(resizer => {
                resizer.addEventListener('mousedown', (e) => {
                    if (isMaximized) return;
                    e.preventDefault();
                    
                    resizer.classList.add('is-resizing');

                    let startX = e.clientX, startY = e.clientY;
                    let startWidth = win.offsetWidth, startHeight = win.offsetHeight;
                    let startLeft = win.offsetLeft, startTop = win.offsetTop;
                    
                    const onResize = (e) => {
                        const dx = e.clientX - startX, dy = e.clientY - startY;
                        if (resizer.classList.contains('right') || resizer.classList.contains('bottom-right') || resizer.classList.contains('top-right')) win.style.width = `${startWidth + dx}px`;
                        if (resizer.classList.contains('bottom') || resizer.classList.contains('bottom-right') || resizer.classList.contains('bottom-left')) win.style.height = `${startHeight + dy}px`;
                        if (resizer.classList.contains('left') || resizer.classList.contains('bottom-left') || resizer.classList.contains('top-left')) { win.style.width = `${startWidth - dx}px`; win.style.left = `${startLeft + dx}px`; }
                        if (resizer.classList.contains('top') || resizer.classList.contains('top-right') || resizer.classList.contains('top-left')) { win.style.height = `${startHeight - dy}px`; win.style.top = `${startTop + dy}px`; }
                    };
                    
                    const onStopResize = () => {
                        resizer.classList.remove('is-resizing');
                        document.removeEventListener('mousemove', onResize);
                    };

                    document.addEventListener('mousemove', onResize);
                    document.addEventListener('mouseup', onStopResize, { once: true });
                });
            });
        }
    }

    /* ==========================================================================
       4. 데스크톱 아이콘 이벤트
    ========================================================================== */
    desktopIcons.forEach(icon => {
        let clickTimer = null;
        icon.addEventListener('click', function(e) {
            e.preventDefault();
            if (clickTimer) { // 더블클릭
                clearTimeout(clickTimer);
                clickTimer = null;
                if (this.dataset.openMode === 'window') {
                    createWindow({ title: this.dataset.title, iframeSrc: this.href, iconUrl: this.dataset.iconUrl });
                }
            } else { // 싱글클릭
                clickTimer = setTimeout(() => {
                    clickTimer = null;
                    desktopIcons.forEach(otherIcon => otherIcon.classList.remove('selected'));
                    this.classList.add('selected');
                }, 200);
            }
        });
    });

    /* ==========================================================================
           4-1. 바탕화면 드래그 선택 기능
        ========================================================================== */
        let isDragSelecting = false;
        let selectionRectangle = null;
        let startX = 0, startY = 0;

        desktopArea.addEventListener('mousedown', (e) => {
            // 아이콘, 창, 작업표시줄, 시작메뉴 위에서 시작되면 기능 비활성화
            if (e.target.closest('.desktop-icon') || e.target.closest('.window') || e.target.closest('.taskbar') || e.target.closest('.start-menu')) {
                return;
            }
            
            isDragSelecting = true;
            window.dragSelectionCompleted = false; // 드래그 선택 시작 시 플래그 초기화
            
            // #desktop-area 내부에서의 상대적인 마우스 위치 계산
            const rect = desktopArea.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;

            // 선택 사각형 div 생성 및 초기화
            selectionRectangle = document.createElement('div');
            selectionRectangle.className = 'selection-rectangle';
            selectionRectangle.style.left = `${startX}px`;
            selectionRectangle.style.top = `${startY}px`;
            selectionRectangle.style.width = '0px';
            selectionRectangle.style.height = '0px';
            desktopArea.appendChild(selectionRectangle);

            // 문서 전체에 이벤트 리스너를 추가하여 드래그가 끊기지 않게 함
            document.addEventListener('mousemove', onDragSelect);
            document.addEventListener('mouseup', onStopDragSelect, { once: true });
        });

        function onDragSelect(e) {
            if (!isDragSelecting) return;

            const rect = desktopArea.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            // 사각형의 너비와 높이, 그리고 시작 위치 계산
            const width = Math.abs(currentX - startX);
            const height = Math.abs(currentY - startY);
            const newLeft = Math.min(startX, currentX);
            const newTop = Math.min(startY, currentY);

            // 사각형 스타일 실시간 업데이트
            selectionRectangle.style.left = `${newLeft}px`;
            selectionRectangle.style.top = `${newTop}px`;
            selectionRectangle.style.width = `${width}px`;
            selectionRectangle.style.height = `${height}px`;

            // 드래그 선택 영역과 겹치는 아이콘들 찾기
            const desktopIcons = document.querySelectorAll('.desktop-icon');
            desktopIcons.forEach(icon => {
                const iconRect = icon.getBoundingClientRect();
                const iconLeft = iconRect.left - rect.left;
                const iconTop = iconRect.top - rect.top;
                const iconRight = iconLeft + iconRect.width;
                const iconBottom = iconTop + iconRect.height;

                // 아이콘이 선택 사각형과 겹치는지 확인
                const isIntersecting = !(newLeft > iconRight || 
                                       newLeft + width < iconLeft || 
                                       newTop > iconBottom || 
                                       newTop + height < iconTop);

                if (isIntersecting) {
                    icon.classList.add('drag-selected');
                    icon.classList.remove('drag-selected-final'); // 기존 최종 선택 상태 제거
                } else {
                    icon.classList.remove('drag-selected');
                }
            });
        }

        function onStopDragSelect() {
            isDragSelecting = false;
            if (selectionRectangle) {
                selectionRectangle.remove(); // 드래그가 끝나면 사각형 제거
            }
            // 드래그 선택된 아이콘들을 최종 선택 상태로 변경
            const selectedIcons = document.querySelectorAll('.desktop-icon.drag-selected');
            selectedIcons.forEach(icon => {
                icon.classList.remove('drag-selected');
                icon.classList.add('drag-selected-final');
            });
            document.removeEventListener('mousemove', onDragSelect);
            
            // 드래그 선택이 완료되었음을 표시하는 플래그 설정
            window.dragSelectionCompleted = true;
        }

    /* ==========================================================================
       5. 시작 메뉴 기능
    ========================================================================== */
    const startMenuLeft = document.getElementById('startMenuLeft');
    const startMenuRight = document.getElementById('startMenuRight');
    const appLinks = [
        // 왼쪽 열
        { name: 'Internet', sub: 'Internet Explorer', icon: './image/explore.png', type: 'main', url: 'https://www.google.com' },
        { name: 'E-mail', sub: 'Outlook Express', icon: './image/messenger.png', type: 'main' },
        { separator: true, type: 'left' },
        { name: '그림판', icon: './image/mspaint.png', type: 'recent', url: './jspaint/index.html' },
        { name: '문서편집기', icon: './image/texteditor.png', type: 'recent', url: './texteditor.html' },
        { name: '미디어 플레이어', icon: './image/mediaplayer.png', type: 'recent', url: './webamp/index.html' },
        { separator: true, type: 'left' },
        { name: '모든 프로그램', icon: './image/allprogram.png', type: 'all' },
        // 오른쪽 열
        { name: '내 문서', icon: './image/docfolder.png', type: 'my', url: './folder.html' },
        { name: '내 최근 문서', icon: './image/recentfolder.png', type: 'my' },
        { name: '내 컴퓨터', icon: './image/mycomputer.png', type: 'my' },
        { separator: true, type: 'right' },
        { name: '제어판', icon: './image/panel.png', type: 'settings' },
        { separator: true, type: 'right' },
        { name: '도움말 및 지원', icon: './image/info.png', type: 'support' },
        { name: '검색', icon: './image/search.png', type: 'support' },
        { name: '실행...', icon: './image/execute.png', type: 'support' },
    ];

    function createMenuItem(linkData, isMain = false) {
        if (linkData.separator) {
            const separator = document.createElement('div');
            separator.className = 'start-menu-separator';
            return separator;
        }
        const linkElement = document.createElement('a');
        linkElement.className = 'start-menu-item';
        linkElement.href = linkData.url || '#';
        const iconElement = document.createElement('img');
        iconElement.src = linkData.icon || './image/default-icon.png';
        const textWrapper = document.createElement('div');
        textWrapper.className = 'text-wrapper';
        const textElement = document.createElement('span');
        textElement.textContent = linkData.name;
        if (isMain) textElement.style.fontWeight = 'bold';
        textWrapper.appendChild(textElement);
        if (linkData.sub) {
            const subText = document.createElement('small');
            subText.textContent = linkData.sub;
            textWrapper.appendChild(subText);
        }
        linkElement.appendChild(iconElement);
        linkElement.appendChild(textWrapper);
        // Turn Off Computer 메뉴에만 id 부여
        if (linkData.name === 'Turn Off Computer') {
            linkElement.id = 'turnoff-menu-item';
        }
        linkElement.addEventListener('click', (e) => {
            e.preventDefault();
            if (linkData.url && linkData.url !== '#') {
                createWindow({ title: linkData.name, iframeSrc: linkData.url, iconUrl: linkData.icon });
                startMenu.classList.remove('show');
            }
            if (linkData.type === 'all') alert('모든 프로그램 기능은 아직 구현되지 않았습니다.');
            // Turn Off Computer 메뉴 클릭 시 오버레이 표시
            if (linkData.name === 'Turn Off Computer') {
                const overlay = document.getElementById('turnoff-overlay');
                overlay.style.display = 'block';
            }
        });
        return linkElement;
    }

    function renderStartMenu() {
        startMenuLeft.innerHTML = '';
        startMenuRight.innerHTML = '';
        appLinks.filter(link => link.type === 'main' || link.type === 'internet').forEach(link => startMenuLeft.appendChild(createMenuItem(link, true)));
        startMenuLeft.appendChild(createMenuItem({ separator: true }));
        appLinks.filter(link => link.type === 'recent').forEach(link => startMenuLeft.appendChild(createMenuItem(link, false)));
        startMenuLeft.appendChild(createMenuItem({ separator: true }));
        appLinks.filter(link => link.type === 'all').forEach(link => startMenuLeft.appendChild(createMenuItem(link, true)));
        appLinks.filter(link => link.type === 'my').forEach(link => startMenuRight.appendChild(createMenuItem(link)));
        appLinks.filter(link => link.type === 'settings').forEach(link => startMenuRight.appendChild(createMenuItem(link)));
        appLinks.filter(link => link.type === 'support').forEach(link => startMenuRight.appendChild(createMenuItem(link)));
    }

    /* ==========================================================================
       6. 컨텍스트 메뉴 (오른쪽 클릭) 기능
    ========================================================================== */
    function removeContextMenu() {
        if (currentContextMenu) {
            currentContextMenu.remove();
            currentContextMenu = null;
        }
    }

    function createContextMenu(items, x, y) {
        removeContextMenu();
        const menu = document.createElement('ul');
        menu.className = 'context-menu';
        items.forEach(item => {
            const li = document.createElement('li');
            if (item.separator) {
                li.className = 'context-menu-separator';
            } else {
                li.className = 'context-menu-item';
                li.textContent = item.text;
                if (item.action) li.addEventListener('click', item.action);
            }
            menu.appendChild(li);
        });
        document.body.appendChild(menu);
        const menuWidth = menu.offsetWidth, menuHeight = menu.offsetHeight;
        if (x + menuWidth > window.innerWidth) x = window.innerWidth - menuWidth;
        if (y + menuHeight > window.innerHeight) y = window.innerHeight - menuHeight;
        menu.style.left = `${x}px`;
        menu.style.top = `${y}px`;
        currentContextMenu = menu;
    }

    const desktopMenuItems = [
        { text: '아이콘 정렬 순서' }, { separator: true },
        { text: '새로 고침', action: () => location.reload() }, { separator: true },
        { text: '새로 만들기' }, { separator: true },
        { text: '속성' }
    ];

    /* ==========================================================================
       7. 전역 이벤트 리스너 설정
    ========================================================================== */

    // 바탕화면 우클릭 이벤트
    desktopArea.addEventListener('contextmenu', (e) => {
        if (!e.target.closest('.desktop-icon') && !e.target.closest('.window')) {
            e.preventDefault();
            createContextMenu(desktopMenuItems, e.clientX, e.clientY);
        }
    });

    // 시작 버튼 클릭 이벤트
    startButton.addEventListener('click', (e) => {
        e.stopPropagation();
        startMenu.classList.toggle('show');
    });

    // 볼륨 아이콘 클릭 이벤트
    volumeIconContainer.addEventListener('click', (e) => {
        e.stopPropagation();
        volumePopup.classList.toggle('show');
    });
    volumePopup.addEventListener('click', (e) => e.stopPropagation());

    // 문서 전체 클릭 이벤트 (메뉴 닫기 등)
    document.addEventListener('click', (e) => {
        if (currentContextMenu && !currentContextMenu.contains(e.target)) removeContextMenu();
        if (startMenu.classList.contains('show') && !startMenu.contains(e.target) && !startButton.contains(e.target)) {
            startMenu.classList.remove('show');
        }
        if (volumePopup.classList.contains('show') && !volumeIconContainer.contains(e.target)) {
            volumePopup.classList.remove('show');
        }
        if (!e.target.closest('.desktop-icon')) {
            desktopIcons.forEach(icon => icon.classList.remove('selected'));
        }
        
        // 드래그 선택 해제 (다른 곳 클릭 시) - 드래그 선택이 완료된 후에만
        if (!isDragSelecting && window.dragSelectionCompleted) {
            document.querySelectorAll('.desktop-icon.drag-selected-final').forEach(icon => {
                icon.classList.remove('drag-selected-final');
            });
            window.dragSelectionCompleted = false; // 플래그 초기화
        }
    });

    /* ==========================================================================
   7-1. 알림 영역 볼륨 조절 기능 연결 (새로 추가)
   ========================================================================== */

// 슬라이더 값 변경 시 전역 볼륨 업데이트 및 모든 창에 적용
volumeSlider.addEventListener('input', (e) => {
    globalVolume = e.target.value / 100;
    muteCheckbox.checked = false; // 볼륨 조절 시 음소거 해제
    isGlobalMuted = false;
    applyGlobalAudioState();
});

// 음소거 체크 시 전역 음소거 상태 업데이트 및 모든 창에 적용
muteCheckbox.addEventListener('change', (e) => {
    isGlobalMuted = e.target.checked;
    applyGlobalAudioState();
});

    /* ==========================================================================
       8. 초기화 실행
    ========================================================================== */
    updateClock();
    setInterval(updateClock, 1000);
    renderStartMenu();

    // startup.wav 페이지 로드 시마다 재생 기능
    function playStartupSound() {
        console.log('startup.wav 재생 시도...');
        console.log('현재 볼륨:', globalVolume);
        console.log('음소거 상태:', isGlobalMuted);
        
        const startupAudio = new Audio('./startup.wav');
        startupAudio.volume = globalVolume;
        startupAudio.muted = isGlobalMuted;
        
        // 오디오 로드 완료 후 재생
        startupAudio.addEventListener('canplaythrough', () => {
            console.log('startup.wav 로드 완료, 재생 시작');
            startupAudio.play().then(() => {
                console.log('startup.wav 재생 성공');
            }).catch(error => {
                console.log('startup.wav 재생 실패:', error);
            });
        });
        
        startupAudio.addEventListener('error', (error) => {
            console.log('startup.wav 로드 실패:', error);
        });
        
        // 오디오 로드 시작
        startupAudio.load();
    }

    // 사용자 상호작용 후 startup.wav 재생
    let startupSoundPlayed = false;
    
    // 사용자가 페이지를 클릭했을 때 startup.wav 재생
    document.addEventListener('click', () => {
        if (!startupSoundPlayed) {
            playStartupSound();
            startupSoundPlayed = true;
        }
    }, { once: true });

    // 폴더 창에서 전송된 메시지 처리
    window.addEventListener('message', (event) => {
        if (event.data.type === 'createWindow') {
            createWindow(event.data);
        }
    });

    // 핀볼 아이콘 클릭 시 창 생성
    const pinballIcon = document.getElementById('pinball-icon');
    if (pinballIcon) {
        pinballIcon.addEventListener('dblclick', function(e) {
            e.preventDefault();
            createWindow({
                title: '3D Pinball for Windows - Space Cadet',
                iframeSrc: './pinball/space-cadet.html',
                iconUrl: './image/pinball.png',
                width: 600,
                height: 475,
                resizable: false // 크기 조절 불가 옵션 추가
            });
        });
        // 싱글클릭 선택, 더블클릭 실행을 위해 기존 click 이벤트도 유지
    }

    // 마인스위퍼 아이콘 클릭 시 창 생성
    const minesweeperIcon = document.getElementById('minesweeper-icon');
    if (minesweeperIcon) {
        minesweeperIcon.addEventListener('dblclick', function(e) {
            e.preventDefault();
            createWindow({
                title: 'Minesweeper',
                iframeSrc: './minesweeper/index.html',
                iconUrl: './image/minesweeper.png',
                width: 280,
                height: 355, 
                resizable: false // 크기 조절 불가 옵션 추가
            });
        });
        // 싱글클릭 선택, 더블클릭 실행을 위해 기존 click 이벤트도 유지
    }

    // 화면보호기 아이콘 클릭 시 pipes/index.html을 새 창이 아니라 오버레이로 전체화면 표시
    const screensaverIcon = document.getElementById('screensaver-icon');
    if (screensaverIcon) {
        screensaverIcon.addEventListener('dblclick', function(e) {
            e.preventDefault();
            // 오버레이 보이기 및 iframe src 설정
            const overlay = document.getElementById('screensaver-overlay');
            const iframe = document.getElementById('screensaver-iframe');
            overlay.style.display = 'block';
            iframe.src = './pipes/index.html';
            // F11 전체화면 진입 코드 제거 (사이트 내에서만 전체화면)
        });
    }
    // 입력 감지 시 오버레이 및 전체화면 해제 (postMessage 방식)
    window.addEventListener('message', function(event) {
        if (event.data === 'exitScreensaver') {
            const overlay = document.getElementById('screensaver-overlay');
            const iframe = document.getElementById('screensaver-iframe');
            overlay.style.display = 'none';
            iframe.src = '';
            if (document.exitFullscreen) document.exitFullscreen();
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
            else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
            else if (document.msExitFullscreen) document.msExitFullscreen();
        }
    });

    // Flower 화면보호기 아이콘 클릭 시 flower/index.html을 오버레이로 전체화면 표시
    const flowerScreensaverIcon = document.getElementById('flower-screensaver-icon');
    if (flowerScreensaverIcon) {
        flowerScreensaverIcon.addEventListener('dblclick', function(e) {
            e.preventDefault();
            const overlay = document.getElementById('flower-screensaver-overlay');
            const iframe = document.getElementById('flower-screensaver-iframe');
            overlay.style.display = 'block';
            iframe.src = './flower/index.html';
        });
    }
    // 입력 감지 시 오버레이 해제 (postMessage 방식)
    window.addEventListener('message', function(event) {
        if (event.data === 'exitFlowerScreensaver') {
            const overlay = document.getElementById('flower-screensaver-overlay');
            const iframe = document.getElementById('flower-screensaver-iframe');
            overlay.style.display = 'none';
            iframe.src = '';
        }
    });

    // Turn Off Computer 메뉴 클릭 시 오버레이로 turnoff-dialog 표시 (iframe 코드 제거)
    const turnOffButton = document.getElementById('turnOffButton');
    if (turnOffButton) {
        turnOffButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const overlay = document.getElementById('turnoff-overlay');
            overlay.style.display = 'block';
        });
    }
    const taskbarTurnoffContainer = document.getElementById('taskbar-turnoff-container');
    if (taskbarTurnoffContainer) {
        taskbarTurnoffContainer.addEventListener('click', (e) => {
            e.stopPropagation();
            const overlay = document.getElementById('turnoff-overlay');
            overlay.style.display = 'block';
        });
    }

    // 오버레이 버튼 이벤트 등록 (DOMContentLoaded 내에 추가)
    document.getElementById('turnoff-cancel-btn').onclick = () => {
        document.getElementById('turnoff-overlay').style.display = 'none';
    };
    document.getElementById('standby-btn').onclick = () => alert('Stand By (Demo)');
    document.getElementById('turnoff-btn').onclick = () => alert('Turn Off (Demo)');
    document.getElementById('restart-btn').onclick = () => alert('Restart (Demo)');

    // 오버레이 입력 감지 시 닫기 (Cancel 버튼은 turnoff.html에서 window.close()로 처리)
    window.addEventListener('message', function(event) {
        if (event.data === 'exitTurnoffOverlay') {
            const overlay = document.getElementById('turnoff-overlay');
            overlay.style.display = 'none';
        }
    });
});

</script>

</body>

</html>